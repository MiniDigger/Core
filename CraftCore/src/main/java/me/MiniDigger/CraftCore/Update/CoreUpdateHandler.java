/**
 * ██████████████████████████████████████████████████████████████████████████████████████████████████████████████
 * █░░░░░░░░░░░░░░█░░░░░░██░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░░░███░░░░░░░░░░░░░░█
 * █░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░█
 * █░░░░░░▄▀░░░░░░█░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░████░░▄▀░░███░░▄▀░░█████████
 * █████░░▄▀░░█████░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░█
 * █████░░▄▀░░█████░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░▄▀░░░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█████░░▄▀░░█████████
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░██░░▄▀░░░░░░█░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█
 * █████░░░░░░█████░░░░░░██░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░██░░░░░░░░░░█░░░░░░░░░░░░░░█
 * ██████████████████████████████████████████████████████████████████████████████████████████████████████████████
 */

/**
 *
 * ██████████████████████████████████████████████████████████████████████████████████████████████████████████████
 * █░░░░░░░░░░░░░░█░░░░░░██░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░░░███░░░░░░░░░░░░░░█
 * █░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░█
 * █░░░░░░▄▀░░░░░░█░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░████░░▄▀░░███░░▄▀░░█████████
 * █████░░▄▀░░█████░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░█
 * █████░░▄▀░░█████░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░▄▀░░░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█████░░▄▀░░█████████
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░██░░▄▀░░░░░░█░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█
 * █████░░░░░░█████░░░░░░██░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░██░░░░░░░░░░█░░░░░░░░░░░░░░█
 * ██████████████████████████████████████████████████████████████████████████████████████████████████████████████
 */

package me.MiniDigger.CraftCore.Update;

import java.io.BufferedInputStream;
import java.io.BufferedReader;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.net.URL;
import java.util.regex.Pattern;

import me.MiniDigger.Core.Core;
import me.MiniDigger.Core.Update.UpdateHandler;
import me.MiniDigger.Core.Update.UpdateHandler.PluginVersion;
import me.MiniDigger.Core.Update.UpdateType;
import me.MiniDigger.CraftCore.CoreMain;

import org.bukkit.Bukkit;

public class CoreUpdateHandler implements UpdateHandler {
	
	private static final int	BYTE_SIZE	 = 1024;
	private static final String	JAR_URL	     = "http://game-repo.minidigger.me/TheCore/TheCore.jar";
	private static final String	VERSIONS_URL	= "http://game-repo.minidigger.me/TheCore/version.txt";
	
	private UpdateType	        type;
	
	public CoreUpdateHandler() {
		type = UpdateType.valueOf(((CoreMain) Core.getCore().getInstance()).getConfig().getString("update-type"));
	}
	
	public boolean updateCheck() {
		if (getLatestVersion().isNewer(getVersion(), type)) {
			new Thread(new Runnable() {
				
				@Override
				public void run() {
					saveFile(new File(((CoreMain) Core.getCore().getInstance()).getDataFolder().getParent(), Bukkit.getServer().getUpdateFolder()), "TheCore.jar",
					        JAR_URL);
				}
				
			}).start();
			return true;
		}
		System.out.println("not newer!");
		return false;
	}
	
	private PluginVersion getVersion() {
		return new CorePluginVersion(((CoreMain) Core.getCore().getInstance()).getDescription().getVersion());
	}
	
	private PluginVersion getLatestVersion() {
		try {
			final URL url = new URL(VERSIONS_URL);
			final BufferedReader in = new BufferedReader(new InputStreamReader(url.openStream()));
			String inputLine;
			
			while ((inputLine = in.readLine()) != null) {
				return new CorePluginVersion(inputLine);
			}
			
			in.close();
		} catch (final IOException e) {
			e.printStackTrace();
			return null;
		}
		return null;
	}
	
	private void saveFile(final File folder, final String file, final String link) {
		if (!folder.exists()) {
			folder.mkdir();
		}
		BufferedInputStream in = null;
		FileOutputStream fout = null;
		try {
			// Download the file
			final URL url = new URL(link);
			final int fileLength = url.openConnection().getContentLength();
			in = new BufferedInputStream(url.openStream());
			fout = new FileOutputStream(folder.getAbsolutePath() + File.separator + file);
			
			final byte[] data = new byte[BYTE_SIZE];
			int count;
			
			long downloaded = 0;
			while ((count = in.read(data, 0, BYTE_SIZE)) != -1) {
				downloaded += count;
				fout.write(data, 0, count);
				final int percent = (int) ((downloaded * 100) / fileLength);
				if (((percent % 10) == 0)) {
					Core.getCore().getInstance().info("Downloading update: " + percent + "% of " + fileLength + " bytes.");
				}
			}
			
			Core.getCore().getInstance().info("Finished updating. Shutting down");
			if (in != null) {
				in.close();
			}
			if (fout != null) {
				fout.close();
			}
			Bukkit.getServer().shutdown();
		} catch (final Exception ex) {
			Core.getCore().getInstance().error("The auto-updater tried to download a new update, but was unsuccessful. " + ex.getMessage());
		} finally {
			try {
				if (in != null) {
					in.close();
				}
				if (fout != null) {
					fout.close();
				}
			} catch (final Exception ex) {}
		}
	}
}

class CorePluginVersion implements PluginVersion {
	
	String	raw;
	int	   major;
	int	   minor;
	int	   commit;
	int	   build;
	
	public CorePluginVersion(final String raw) {
		final String[] s = raw.split(Pattern.quote("."));
		major = Integer.parseInt(s[0]);
		minor = Integer.parseInt(s[1]);
		commit = Integer.parseInt(s[2].split("-")[0].replace(" ", ""));
		try {
			build = Integer.parseInt(s[2].split("-")[1]);
		} catch (Exception ex) {
			build = 0;
		}
	}
	
	public boolean isNewer(final PluginVersion other, final UpdateType type) {
		switch (type) {
		case FORCE:
			return true;
		case SNAPSHOT:
			if (isNewer(other, UpdateType.COMMIT) || build > other.getBuild()) {
				return true;
			}
			if (isNewerOrEqual(other, UpdateType.COMMIT) && build > other.getBuild()) {
				return true;
			}
			break;
		case COMMIT:
			if (isNewer(other, UpdateType.MINOR) || commit > other.getCommit()) {
				return true;
			}
			if (isNewerOrEqual(other, UpdateType.MINOR) && commit > other.getCommit()) {
				return true;
			}
			break;
		case MINOR:
			if (isNewer(other, UpdateType.MAJOR) || minor > other.getMinor()) {
				return true;
			}
			if (isNewerOrEqual(other, UpdateType.MAJOR) && minor > other.getMinor()) {
				return true;
			}
			break;
		case MAJOR:
			if (major > other.getMajor()) {
				return true;
			}
			break;
		case NEVER:
			return false;
		}
		return false;
	}
	
	public boolean isNewerOrEqual(PluginVersion other, UpdateType type) {
		switch (type) {
		case FORCE:
			return true;
		case SNAPSHOT:
			if (isNewerOrEqual(other, UpdateType.COMMIT) && build >= other.getBuild()) {
				return true;
			}
			break;
		case COMMIT:
			if (isNewerOrEqual(other, UpdateType.MINOR) && commit >= other.getCommit()) {
				return true;
			}
			break;
		case MINOR:
			if (isNewerOrEqual(other, UpdateType.MAJOR) && minor >= other.getMinor()) {
				return true;
			}
			break;
		case MAJOR:
			if (major >= other.getMajor()) {
				return true;
			}
			break;
		case NEVER:
			return false;
		}
		return false;
	}
	
	@Override
	public void setRaw(String raw) {
		this.raw = raw;
	}
	
	@Override
	public void setMajor(int major) {
		this.major = major;
	}
	
	@Override
	public void setMinor(int minor) {
		this.minor = minor;
	}
	
	@Override
	public void setCommit(int commit) {
		this.commit = commit;
	}
	
	@Override
	public void setBuild(int build) {
		this.build = build;
	}
	
	@Override
	public String getRaw() {
		return raw;
	}
	
	@Override
	public int getMajor() {
		return major;
	}
	
	@Override
	public int getMinor() {
		return minor;
	}
	
	@Override
	public int getCommit() {
		return commit;
	}
	
	@Override
	public int getBuild() {
		return build;
	}
}
