/**
 * ██████████████████████████████████████████████████████████████████████████████████████████████████████████████
 * █░░░░░░░░░░░░░░█░░░░░░██░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░░░███░░░░░░░░░░░░░░█
 * █░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░█
 * █░░░░░░▄▀░░░░░░█░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░████░░▄▀░░███░░▄▀░░█████████
 * █████░░▄▀░░█████░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░█
 * █████░░▄▀░░█████░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░▄▀░░░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█████░░▄▀░░█████████
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░██░░▄▀░░░░░░█░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█
 * █████░░░░░░█████░░░░░░██░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░██░░░░░░░░░░█░░░░░░░░░░░░░░█
 * ██████████████████████████████████████████████████████████████████████████████████████████████████████████████
 */

/**
 *
 * ██████████████████████████████████████████████████████████████████████████████████████████████████████████████
 * █░░░░░░░░░░░░░░█░░░░░░██░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░░░███░░░░░░░░░░░░░░█
 * █░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░█
 * █░░░░░░▄▀░░░░░░█░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░████░░▄▀░░███░░▄▀░░█████████
 * █████░░▄▀░░█████░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░█
 * █████░░▄▀░░█████░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░▄▀░░░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█████░░▄▀░░█████████
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░██░░▄▀░░░░░░█░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█
 * █████░░░░░░█████░░░░░░██░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░██░░░░░░░░░░█░░░░░░░░░░░░░░█
 * ██████████████████████████████████████████████████████████████████████████████████████████████████████████████
 */

package me.MiniDigger.CraftCore.Bar;

import java.lang.reflect.Method;

import me.MiniDigger.Core.Core;
import me.MiniDigger.Core.Bar.FakeDragon;

import org.bukkit.Location;

public class CoreFakeDragon implements FakeDragon{
	
	private static final int	MAX_HEALTH	= 200;
	private int	             id;
	private int	             x;
	private int	             y;
	private int	             z;
	private int	             pitch	       = 0;
	private int	             yaw	       = 0;
	private byte	         xvel	       = 0;
	private byte	         yvel	       = 0;
	private byte	         zvel	       = 0;
	private float	         health;
	private boolean	         visible	   = false;
	private String	         name;
	private Object	         world;
	
	private Object	         dragon;
	
	public CoreFakeDragon(Location loc, String name, float percent) {
		this.name = name;
		this.x = loc.getBlockX();
		this.y = loc.getBlockY();
		this.z = loc.getBlockZ();
		this.health = percent * MAX_HEALTH;
		this.world = Core.getCore().getReflectionUtil().getHandle(loc.getWorld());
	}
	
	public void setHealth(float percent) {
		this.health = (percent / MAX_HEALTH);
	}
	
	public void setHealth(double health){
		this.health = (float) health;
	}
	
	public void setName(String name) {
		this.name = name;
	}
	
	public Object getSpawnPacket() {
		Class<?> Entity = Core.getCore().getReflectionUtil().getCraftClass("Entity");
		Class<?> EntityLiving = Core.getCore().getReflectionUtil().getCraftClass("EntityLiving");
		Class<?> EntityEnderDragon = Core.getCore().getReflectionUtil().getCraftClass("EntityEnderDragon");
		
		try {
			dragon = EntityEnderDragon.getConstructor(Core.getCore().getReflectionUtil().getCraftClass("World")).newInstance(world);
			
			Core.getCore().getReflectionUtil().getMethod(EntityEnderDragon, "setLocation", double.class, double.class, double.class, float.class, float.class)
			        .invoke(dragon, x, y, z, pitch, yaw);
			Core.getCore().getReflectionUtil().getMethod(EntityEnderDragon, "setInvisible", boolean.class).invoke(dragon, visible);
			Core.getCore().getReflectionUtil().getMethod(EntityEnderDragon, "setCustomName", String.class).invoke(dragon, name);
			Core.getCore().getReflectionUtil().getMethod(EntityEnderDragon, "setHealth", float.class).invoke(dragon, health);
			
			Core.getCore().getReflectionUtil().getField(Entity, "motX").set(dragon, xvel);
			Core.getCore().getReflectionUtil().getField(Entity, "motY").set(dragon, yvel);
			Core.getCore().getReflectionUtil().getField(Entity, "motZ").set(dragon, zvel);
			
			this.id = (Integer) Core.getCore().getReflectionUtil().getMethod(EntityEnderDragon, "getId").invoke(dragon);
			
			Class<?> packetClass = Core.getCore().getReflectionUtil().getCraftClass("PacketPlayOutSpawnEntityLiving");
			return packetClass.getConstructor(new Class<?>[] { EntityLiving }).newInstance(dragon);
		} catch (Exception e) {
			e.printStackTrace();
			return null;
		}
	}
	
	public Object getDestroyPacket() {
		try {
			Class<?> packetClass = Core.getCore().getReflectionUtil().getCraftClass("PacketPlayOutEntityDestroy");
			return packetClass.getConstructor(new Class<?>[] { int[].class }).newInstance(new int[] { id });
		} catch (Exception e) {
			e.printStackTrace();
			return null;
		}
	}
	
	public Object getMetaPacket(Object watcher) {
		try {
			Class<?> watcherClass = Core.getCore().getReflectionUtil().getCraftClass("DataWatcher");
			Class<?> packetClass = Core.getCore().getReflectionUtil().getCraftClass("PacketPlayOutEntityMetadata");
			return packetClass.getConstructor(new Class<?>[] { int.class, watcherClass, boolean.class }).newInstance(id, watcher, true);
		} catch (Exception e) {
			e.printStackTrace();
			return null;
		}
	}
	
	public Object getTeleportPacket(Location loc) {
		try {
			Class<?> packetClass = Core.getCore().getReflectionUtil().getCraftClass("PacketPlayOutEntityTeleport");
			return packetClass.getConstructor(new Class<?>[] { int.class, int.class, int.class, int.class, byte.class, byte.class }).newInstance(this.id,
			        loc.getBlockX() * 32, loc.getBlockY() * 32, loc.getBlockZ() * 32, (byte) ((int) loc.getYaw() * 256 / 360), (byte) ((int) loc.getPitch() * 256 / 360));
		} catch (Exception e) {
			e.printStackTrace();
			return null;
		}
	}
	
	public Object getWatcher() {
		Class<?> Entity = Core.getCore().getReflectionUtil().getCraftClass("Entity");
		Class<?> DataWatcher = Core.getCore().getReflectionUtil().getCraftClass("DataWatcher");
		
		try {
			Object watcher = DataWatcher.getConstructor(new Class<?>[] { Entity }).newInstance(dragon);
			Method a = Core.getCore().getReflectionUtil().getMethod(DataWatcher, "a", new Class<?>[] { int.class, Object.class });
			
			a.invoke(watcher, 0, visible ? (byte) 0 : (byte) 0x20);
			a.invoke(watcher, 6, (Float) health);
			a.invoke(watcher, 7, (Integer) 0);
			a.invoke(watcher, 8, (Byte) (byte) 0);
			a.invoke(watcher, 10, name);
			a.invoke(watcher, 11, (Byte) (byte) 1);
			return watcher;
		} catch (Exception e) {
			e.printStackTrace();
			return null;
		}
	}
}
