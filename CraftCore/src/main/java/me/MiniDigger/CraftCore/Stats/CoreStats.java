/**
 * ██████████████████████████████████████████████████████████████████████████████████████████████████████████████
 * █░░░░░░░░░░░░░░█░░░░░░██░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░░░███░░░░░░░░░░░░░░█
 * █░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░█
 * █░░░░░░▄▀░░░░░░█░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░████░░▄▀░░███░░▄▀░░█████████
 * █████░░▄▀░░█████░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░█
 * █████░░▄▀░░█████░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░▄▀░░░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█████░░▄▀░░█████████
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░██░░▄▀░░░░░░█░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█
 * █████░░░░░░█████░░░░░░██░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░██░░░░░░░░░░█░░░░░░░░░░░░░░█
 * ██████████████████████████████████████████████████████████████████████████████████████████████████████████████
 */

/**
 *
 * ██████████████████████████████████████████████████████████████████████████████████████████████████████████████
 * █░░░░░░░░░░░░░░█░░░░░░██░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░░░███░░░░░░░░░░░░░░█
 * █░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░█
 * █░░░░░░▄▀░░░░░░█░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░████░░▄▀░░███░░▄▀░░█████████
 * █████░░▄▀░░█████░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░█
 * █████░░▄▀░░█████░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░▄▀░░░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█████░░▄▀░░█████████
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░██░░▄▀░░░░░░█░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█
 * █████░░░░░░█████░░░░░░██░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░██░░░░░░░░░░█░░░░░░░░░░░░░░█
 * ██████████████████████████████████████████████████████████████████████████████████████████████████████████████
 */

package me.MiniDigger.CraftCore.Stats;

import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.HashMap;
import java.util.UUID;

import org.bukkit.Bukkit;

import me.MiniDigger.Core.Core;
import me.MiniDigger.Core.SQL.SQLQuery;
import me.MiniDigger.Core.Stats.Stats;
import me.MiniDigger.Core.Stats.StatsType;
import me.MiniDigger.CraftCore.CoreMain;
import me.MiniDigger.CraftCore.SQL.CoreSQLQuery;

public class CoreStats implements Stats {
	
	private UUID	                    user;
	private HashMap<StatsType, Integer>	stats;
	
	public CoreStats(UUID id){
		this.user = id;
	}
	
	@Override
	public boolean save() {
		// create query
		String q = "INSERT INTO `stats`(";
		int rows = 1;
		q += "`uuid`,";
		for (StatsType type : StatsType.values()) {
			q += "`" + type.getGame() + "." + type.getStats() + "`,";
			rows++;
		}
		q = Core.getCore().getStringUtil().replaceLast(q, ",", "");
		q += ") VALUES (";
		for (int i = 0; i < rows; i++) {
			q += "?,";
		}
		q = Core.getCore().getStringUtil().replaceLast(q, ",", "");
		q += ")";
		// Try insertion
		try {
			SQLQuery query = new CoreSQLQuery(q);
			PreparedStatement stmt = query.getStatement();
			stmt.setString(1, user.toString());
			int i;
			for (i = 2; i <= StatsType.values().size() + 1; i++) {
				stmt.setLong(i, get(StatsType.values().get(i)));
			}
			stmt.execute();
			query.kill();
		} catch (Exception ex) {
			// Try update
			try {
				// create query
				q = "UPDATE `stats` SET ";
				q += "`uuid`=?,";
				for (StatsType type : StatsType.values()) {
					q += "`" + type.getGame() + "." + type.getStats() + "`=?,";
				}
				q = Core.getCore().getStringUtil().replaceLast(q, ",", "");
				q += "WHERE `uuid` LIKE ?";
				SQLQuery query = new CoreSQLQuery(q);
				PreparedStatement stmt = query.getStatement();
				int i;
				stmt.setString(1, user.toString());
				for (i = 2; i <= StatsType.values().size() + 1; i++) {
					stmt.setLong(i, get(StatsType.values().get(i)));
				}
				stmt.setString(i + 1, user.toString());
				stmt.execute();
				query.kill();
			} catch (Exception e) {
				return false;
			}
		}
		return true;
	}
	
	@Override
	public boolean load() {
		try {
			SQLQuery query = new CoreSQLQuery("SELECT * FROM `stats` WHERE `uuid` LIKE ?");
			PreparedStatement stmt = query.getStatement();
			stmt.setString(1, user.toString());
			
			ResultSet r = stmt.executeQuery();
			if (r == null) {
				throw new NullPointerException("ResultSet returned by query can not be null!");
			}
			
			r.next();
			user = UUID.fromString(r.getString("user"));
			stats = new HashMap<>();
			
			for (StatsType type : StatsType.values()) {
				stats.put(type, (int) r.getLong(type.getGame() + "." + type.getStats()));
			}
			
			query.kill();
		} catch (Exception ex) {
			return false;
		}
		return true;
	}
	
	@Override
	public boolean createTable() {
		String query = "CREATE TABLE IF NOT EXISTS `stats` (";
		
		query += "`uuid` varchar(40) NOT NULL,";
		for (StatsType type : StatsType.values()) {
			query += "`" + type.getGame() + "." + type.getStats() + "` bigint(20) NOT NULL DEFAULT '" + type.getDefaultValue() + "',";
		}
		
		query += "PRIMARY KEY (`uuid`), UNIQUE KEY `uuid` (`uuid`))";
		SQLQuery q = new CoreSQLQuery(query);
		
		try {
			q.getStatement().execute();
			q.kill();
			return true;
		} catch (SQLException e) {
			e.printStackTrace();
			return false;
		}
	}
	
	@Override
	public UUID getUser() {
		return user;
	}
	
	@Override
	public void set(StatsType type, int value) {
		stats.remove(type);
		stats.put(type, value);
	}
	
	@Override
	public void add(StatsType type, int value) {
		set(type, get(type) + value);
	}
	
	@Override
	public void remove(StatsType type, int value) {
		set(type, get(type) - value);
	}
	
	@Override
	public int get(StatsType type) {
		if (type == null) {
			return 0;
		}
		if (stats.get(type) == null) {
			stats.put(type, type.getDefaultValue());
		}
		
		Bukkit.getScheduler().runTaskLaterAsynchronously((CoreMain) Core.getCore().getInstance(), new Runnable() {
			
			@Override
			public void run() {
				load();
			}
		}, 2);
		
		return stats.get(type);
	}
	
	@Override
	public void init() {
		stats = new HashMap<>();
	}
	
}
