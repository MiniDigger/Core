/**
 * ██████████████████████████████████████████████████████████████████████████████████████████████████████████████
 * █░░░░░░░░░░░░░░█░░░░░░██░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░░░███░░░░░░░░░░░░░░█
 * █░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░█
 * █░░░░░░▄▀░░░░░░█░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░████░░▄▀░░███░░▄▀░░█████████
 * █████░░▄▀░░█████░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░█
 * █████░░▄▀░░█████░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░▄▀░░░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█████░░▄▀░░█████████
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░██░░▄▀░░░░░░█░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█
 * █████░░░░░░█████░░░░░░██░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░██░░░░░░░░░░█░░░░░░░░░░░░░░█
 * ██████████████████████████████████████████████████████████████████████████████████████████████████████████████
 */

/**
 *
 * ██████████████████████████████████████████████████████████████████████████████████████████████████████████████
 * █░░░░░░░░░░░░░░█░░░░░░██░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░░░███░░░░░░░░░░░░░░█
 * █░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░█
 * █░░░░░░▄▀░░░░░░█░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░████░░▄▀░░███░░▄▀░░█████████
 * █████░░▄▀░░█████░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░█
 * █████░░▄▀░░█████░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░▄▀░░░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█████░░▄▀░░█████████
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░██░░▄▀░░░░░░█░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█
 * █████░░░░░░█████░░░░░░██░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░██░░░░░░░░░░█░░░░░░░░░░░░░░█
 * ██████████████████████████████████████████████████████████████████████████████████████████████████████████████
 */

package me.MiniDigger.CraftCore.Game;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.UUID;

import me.MiniDigger.Core.Core;
import me.MiniDigger.Core.Error.Error;
import me.MiniDigger.Core.Feature.Feature;
import me.MiniDigger.Core.Game.Game;
import me.MiniDigger.Core.Game.GameType;
import me.MiniDigger.Core.Map.MapData;
import me.MiniDigger.Core.Phase.Phase;
import me.MiniDigger.Core.Prefix.Prefix;
import me.MiniDigger.Core.User.User;
import mkremins.fanciful.FancyMessage;

import org.bukkit.Bukkit;
import org.bukkit.DyeColor;
import org.bukkit.Location;
import org.bukkit.Sound;
import org.bukkit.entity.Player;
import org.bukkit.event.HandlerList;

public class CoreGame implements Game {
	
	private final UUID	                  id	     = UUID.randomUUID();
	private final List<UUID>	          users	     = new ArrayList<>();
	private final HashMap<String, String>	gameData	= new HashMap<>();
	private Phase	                      phase;
	private GameType	                  type;
	private boolean	                      allowJoin;
	private boolean	                      allowSpectate;
	
	@Override
	public Error join(final User user) {
		if (users.contains(user.getUUID())) {
			return Error.USER_ALLREADY_JOINED;
		} else {
			users.add(user.getUUID());
			return Error.NO_ERROR;
		}
	}
	
	@Override
	public Error leave(final User user) {
		Core.getCore().getBarHandler().removeBar(user.getPlayer());
		user.getPlayer().setLevel(0);
		user.getPlayer().setExp(0);
		if (users.contains(user.getUUID())) {
			users.remove(user.getUUID());
			return Error.NO_ERROR;
		} else {
			return Error.USER_NOT_JOINED;
		}
	}
	
	@Override
	public void start() {
	}
	
	@Override
	public UUID getIdentifier() {
		return id;
	}
	
	@Override
	public List<UUID> getPlayers() {
		return users;
	}
	
	@Override
	public void broadCastMessage(final FancyMessage msg) {
		for (final UUID id : users) {
			Core.getCore().getUserHandler().get(id).sendMessage(msg);
		}
	}
	
	@Override
	public void broadCastSound(final Sound sound, final float volume, final float pitch) {
		for (final UUID id : users) {
			Bukkit.getPlayer(id).playSound(Bukkit.getPlayer(id).getLocation(), sound, volume, pitch);
		}
	}
	
	@Override
	public void broadCastSoundAtLocation(final Sound sound, final float volume, final float pitch, final Location loc) {
		for (final UUID id : users) {
			Bukkit.getPlayer(id).playSound(loc, sound, volume, pitch);
		}
	}
	
	@Override
	public FancyMessage getPrefix() {
		return Prefix.getByGameType(getType()).getPrefix();
	}
	
	@Override
	public void init() {
	}
	
	@Override
	public Phase getPhase() {
		return phase;
	}
	
	@Override
	public void setPhase(final Phase nextPhase) {
		phase = nextPhase;
	}
	
	@Override
	public GameType getType() {
		return type;
	}
	
	@Override
	public boolean allowJoin() {
		return allowJoin;
	}
	
	@Override
	public boolean allowSpectate() {
		return allowSpectate;
	}
	
	@Override
	public String getGameData(final String key) {
		return gameData.get(key);
	}
	
	@Override
	public void setGameData(final String key, final String data) {
		if (gameData.containsKey(key)) {
			gameData.remove(gameData.get(key));
		}
		gameData.put(key, data);
	}
	
	@Override
	public void end(final User... winner) {
		final MapData lobby = Core.getCore().getMapHandler().getMap(getGameData("Lobby"));
		final Location loc = lobby.getLocs(DyeColor.RED).values().iterator().next();
		for (final User w : winner) {
			if (w != null) {
				w.getPlayer().teleport(loc);
			}
		}
		
		for (final Player p : Bukkit.getOnlinePlayers()) {
			if (!p.getLocation().getWorld().getName().equalsIgnoreCase(lobby.getName())) {
				p.teleport(loc);
			}
		}
		
		Core.getCore().getGameHandler().removeGame(this);
		HandlerList.unregisterAll(getPhase());
		Core.getCore().getCommandHandler().unregisterCommands(getPhase());
		
		for (final Feature f : getPhase().getFeatures()) {
			HandlerList.unregisterAll(f);
			Core.getCore().getCommandHandler().unregisterCommands(f);
			f.end();
		}
		
		Core.getCore().getShutdownUtil().initShutdown();
		
		try {
			finalize();
		} catch (final Throwable e) {
			e.printStackTrace();
		}
	}
	
}
