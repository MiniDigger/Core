/**
 * ██████████████████████████████████████████████████████████████████████████████████████████████████████████████
 * █░░░░░░░░░░░░░░█░░░░░░██░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░░░███░░░░░░░░░░░░░░█
 * █░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░█
 * █░░░░░░▄▀░░░░░░█░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░████░░▄▀░░███░░▄▀░░█████████
 * █████░░▄▀░░█████░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░█
 * █████░░▄▀░░█████░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░▄▀░░░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█████░░▄▀░░█████████
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░██░░▄▀░░░░░░█░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█
 * █████░░░░░░█████░░░░░░██░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░██░░░░░░░░░░█░░░░░░░░░░░░░░█
 * ██████████████████████████████████████████████████████████████████████████████████████████████████████████████
 */

/**
 *
 * ██████████████████████████████████████████████████████████████████████████████████████████████████████████████
 * █░░░░░░░░░░░░░░█░░░░░░██░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░░░███░░░░░░░░░░░░░░█
 * █░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░█
 * █░░░░░░▄▀░░░░░░█░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░████░░▄▀░░███░░▄▀░░█████████
 * █████░░▄▀░░█████░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░█
 * █████░░▄▀░░█████░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░▄▀░░░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█████░░▄▀░░█████████
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░██░░▄▀░░░░░░█░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█
 * █████░░░░░░█████░░░░░░██░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░██░░░░░░░░░░█░░░░░░░░░░░░░░█
 * ██████████████████████████████████████████████████████████████████████████████████████████████████████████████
 */

package me.MiniDigger.CraftCore.Protocol;

import java.lang.reflect.InvocationTargetException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

import me.MiniDigger.Core.Core;
import me.MiniDigger.Core.Protocol.ProtocolHandler;
import me.MiniDigger.Core.Protocol.SignChangers;
import me.MiniDigger.Core.Protocol.SkullChangers;
import me.MiniDigger.Core.User.User;
import me.MiniDigger.CraftCore.CoreMain;

import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.entity.Player;

import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.ProtocolLibrary;
import com.comphenix.protocol.ProtocolManager;
import com.comphenix.protocol.events.ListenerPriority;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketContainer;
import com.comphenix.protocol.events.PacketEvent;
import com.comphenix.protocol.wrappers.WrappedChatComponent;
import com.comphenix.protocol.wrappers.WrappedGameProfile;
import com.comphenix.protocol.wrappers.WrappedServerPing;

public class CoreProtocolHandler implements ProtocolHandler {
	
	private String	              fame;
	private final ProtocolManager	manager	= ProtocolLibrary.getProtocolManager();
	
	private SignChangers	      signChangers;
	private SkullChangers	      skullChangers;
	
	@Override
	public void init() {
		signChangers = new CoreSignChangers();
		skullChangers = new CoreSkullChangers();
		
		signChangers.init();
		skullChangers.init();
		
		Bukkit.getScheduler().runTaskTimer((CoreMain) Core.getCore().getInstance(), new Runnable() {
			
			@Override
			public void run() {
				final String[] names = new String[] { "MiniDigger", "Notch", "jeb_", "Dinnerbone", };
				
				try {
					fame = Core.getCore().getUserHandler().getOnlinePlayers()
					        .get(Core.getCore().getRandomUtil().nextInt(Core.getCore().getUserHandler().getOnlinePlayers().size())).getName();
				} catch (final Throwable e) {
					fame = names[Core.getCore().getRandomUtil().nextInt(names.length)];
				}
			}
		}, 2 * 20, 2 * 20);
		
		Bukkit.getScheduler().runTaskTimerAsynchronously((CoreMain) Core.getCore().getInstance(), new Runnable() {
			
			@Override
			public void run() {
				signChangers.update();
				skullChangers.update();
			}
		}, 2 * 20, 2 * 20);
		
		manager.addPacketListener(new PacketAdapter((CoreMain) Core.getCore().getInstance(), PacketType.Play.Server.UPDATE_SIGN) {
			
			@Override
			public void onPacketSending(final PacketEvent event) {
				signChangers.handlePacket(event);
			}
		});
		// Skulls
		manager.addPacketListener(new PacketAdapter((CoreMain) Core.getCore().getInstance(), PacketType.Play.Server.TILE_ENTITY_DATA) {
			
			@Override
			public void onPacketSending(final PacketEvent event) {
				skullChangers.handlePacket(event);
			}
		});
		// Ping
		manager.addPacketListener(new PacketAdapter((CoreMain) Core.getCore().getInstance(), ListenerPriority.NORMAL, Arrays
		        .asList(PacketType.Status.Server.OUT_SERVER_INFO)) {
			
			@Override
			public void onPacketSending(final PacketEvent event) {
				handlePing(event.getPacket().getServerPings().read(0));
			}
		});
		// Zensor
		manager.addPacketListener(new PacketAdapter((CoreMain) Core.getCore().getInstance(), PacketType.Play.Server.CHAT) {
			
			@Override
			public void onPacketSending(final PacketEvent event) {
				final WrappedChatComponent chat = event.getPacket().getChatComponents().read(0);
				
				if (chat.getJson().contains("Unable to locate")) {
					event.setCancelled(true);
				}
			}
		});
		// TabBlocker
		manager.addPacketListener(new PacketAdapter((CoreMain) Core.getCore().getInstance(), PacketType.Play.Client.TAB_COMPLETE) {
			
			@Override
			@SuppressWarnings("unchecked")
			public void onPacketReceiving(final PacketEvent event) {
				if (event.getPacketType() == PacketType.Play.Client.TAB_COMPLETE) {
					final User user = Core.getCore().getUserHandler().get(event.getPlayer().getUniqueId());
					if (!user.hasPermission("tabcomplete") && event.getPacket().getStrings().read(0).startsWith("/")) {
						event.setCancelled(true);
						List<String> list = new ArrayList<String>();
						final String start = event.getPacket().getStrings().read(0);
						
						try {
							list.addAll((List<? extends String>) Bukkit.getServer().getClass().getMethod("tabCompleteCommand", Player.class, String.class)
							        .invoke(Bukkit.getServer(), event.getPlayer(), start));
						} catch (final Exception e) {
							e.printStackTrace();
						}
						
						final List<String> allowed = new ArrayList<>();
						// TODO Fix tabblocker
						// for (Command cmd :
						// Core.getCore().getCommandHandler().getCommands()) {
						// if (user.hasPermission(cmd.permission())) {
						// allowed.add(cmd.getMainCommand());
						// }
						// }
						
						final List<String> newList = new ArrayList<>();
						for (final String s : list) {
							if (allowed.contains(s.replaceFirst("/", ""))) {
								newList.add(s);
							}
						}
						
						list = newList;
						
						final String[] tabList = new String[list.size()];
						
						for (int index = 0; index < list.size(); index++) {
							tabList[index] = list.get(index);
						}
						
						final PacketContainer tabComplete = manager.createPacket(PacketType.Play.Server.TAB_COMPLETE);
						tabComplete.getStringArrays().write(0, tabList);
						try {
							manager.sendServerPacket(event.getPlayer(), tabComplete);
						} catch (final InvocationTargetException e) {
							e.printStackTrace();
						}
					}
				}
			}
		});
	}
	
	private void handlePing(final WrappedServerPing ping) {
		ping.setPlayers(Arrays.asList(new WrappedGameProfile("1", ChatColor.RED + "Hallo und willkommen"), new WrappedGameProfile("2", "auf Zone-Games.eu!"),
		        new WrappedGameProfile("3", "Hier findest du vieles.")));
		ping.setVersionName("Please use 1.7.10");
		ping.setPlayersOnline(100);
		ping.setPlayersMaximum(-1);
	}
	
	@Override
	public ProtocolManager getManager() {
		return manager;
	}
	
	@Override
	public String getFame() {
		return fame;
	}
	
	@Override
	public SignChangers getSignChangers() {
		return signChangers;
	}
	
	@Override
	public SkullChangers getSkullSChangers() {
		return skullChangers;
	}
	
}
