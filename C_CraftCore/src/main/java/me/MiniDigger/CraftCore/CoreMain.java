/**
 * ██████████████████████████████████████████████████████████████████████████████████████████████████████████████
 * █░░░░░░░░░░░░░░█░░░░░░██░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░░░███░░░░░░░░░░░░░░█
 * █░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░█
 * █░░░░░░▄▀░░░░░░█░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░████░░▄▀░░███░░▄▀░░█████████
 * █████░░▄▀░░█████░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░█
 * █████░░▄▀░░█████░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░▄▀░░░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█████░░▄▀░░█████████
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░██░░▄▀░░░░░░█░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█
 * █████░░░░░░█████░░░░░░██░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░██░░░░░░░░░░█░░░░░░░░░░░░░░█
 * ██████████████████████████████████████████████████████████████████████████████████████████████████████████████
 */

/**
 *
 * ██████████████████████████████████████████████████████████████████████████████████████████████████████████████
 * █░░░░░░░░░░░░░░█░░░░░░██░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░░░███░░░░░░░░░░░░░░█
 * █░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░█
 * █░░░░░░▄▀░░░░░░█░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░████░░▄▀░░███░░▄▀░░█████████
 * █████░░▄▀░░█████░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░▄▀░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀▄▀░░███░░▄▀▄▀▄▀▄▀▄▀░░█
 * █████░░▄▀░░█████░░▄▀░░░░░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░▄▀░░░░███░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░█████████░░▄▀░░█████████░░▄▀░░██░░▄▀░░█░░▄▀░░██░░▄▀░░█████░░▄▀░░█████████
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░░░░░█░░▄▀░░░░░░▄▀░░█░░▄▀░░██░░▄▀░░░░░░█░░▄▀░░░░░░░░░░█
 * █████░░▄▀░░█████░░▄▀░░██░░▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█░░▄▀░░██░░▄▀▄▀▄▀░░█░░▄▀▄▀▄▀▄▀▄▀░░█
 * █████░░░░░░█████░░░░░░██░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░░░░░░░░░█░░░░░░██░░░░░░░░░░█░░░░░░░░░░░░░░█
 * ██████████████████████████████████████████████████████████████████████████████████████████████████████████████
 */

package me.MiniDigger.CraftCore;

import java.lang.Thread.UncaughtExceptionHandler;
import java.util.logging.Filter;
import java.util.logging.LogRecord;

import me.MiniDigger.Core.Core;
import me.MiniDigger.Core.Main;
import me.MiniDigger.Core.Update.UpdateType;
import me.MiniDigger.Core.User.User;
import me.MiniDigger.CraftCore.Block.CoreBlockListener;
import me.MiniDigger.CraftCore.Chat.CoreChatListener;
import me.MiniDigger.CraftCore.Event.CoreEventListener;
import me.MiniDigger.CraftCore.Socket.CoreSocketClient;
import me.MiniDigger.CraftCore.Socket.CoreSocketServer;
import me.MiniDigger.CraftCore.User.CoreUserListener;
import mkremins.fanciful.FancyMessage;

import org.bukkit.Bukkit;
import org.bukkit.command.CommandSender;
import org.bukkit.entity.Player;
import org.bukkit.event.HandlerList;
import org.bukkit.event.Listener;
import org.bukkit.plugin.java.JavaPlugin;

import ru.tehkode.permissions.PermissionManager;
import ru.tehkode.permissions.bukkit.PermissionsEx;

public class CoreMain extends JavaPlugin implements Main {
	
	private boolean	update	= false;
	
	@Override
	public void onEnable() {
		
		info("Aktiviere " + getDescription().getFullName() + " by MiniDigger");
		new CoreCore(this);
		
		info("Checke Updater...");
		try {
			
			UpdateType.valueOf(getConfig().getString("update-type"));
			if (Core.getCore().getUpdateHandler().updateCheck()) {
				update = true;
				return;
			}
		} catch (Exception e) {
			e.printStackTrace();
		}
		
		info("Setzte Default Config...");
		saveDefaultConfig();
		
		info("Aktiviere Externe Dependencies...");
		try {
			// enableExternalDependencies();//TODO Do we need that?
		} catch (Exception ex) {
			error("Fehler: " + ex.getMessage());
		}
		
		info("Registriere Commands...");
		try {
//			registerCommands(); //TODO Register Commands of AddOns
		} catch (Exception ex) {
			error("Fehler: " + ex.getMessage());
		}
		
		info("Aktiviere Handler...");
		try {
			enableHandler();
		} catch (Exception ex) {
			ex.printStackTrace();
			error("Fehler: " + ex.getMessage());
		}
		
		info("Lade Daten...");
		try {
			loadStuff();
		} catch (Exception ex) {
			error("Fehler: " + ex.getMessage());
			ex.printStackTrace();
		}
		
		info("Registriere Listener...");
		try {
			registerListener();
		} catch (Exception ex) {
			ex.printStackTrace();
			error("Fehler: " + ex.getMessage());
		}

		info("Apply Reload fixes...");
		try {
			fixReload();
		} catch (Exception ex) {
			error("Feheler: " + ex.getMessage());
		}
		
		info("Suche Game...");
		try {
			Core.getCore().getGameHandler().searchMainGame();
		} catch (Exception ex) {
			error("Fehler: " + ex.getMessage());
		}
		
		info("Aktiviert!");
		
		info("Log Stuff...");
		try {
			Thread.setDefaultUncaughtExceptionHandler(new UncaughtExceptionHandler() {
				
				@Override
				public void uncaughtException(Thread t, Throwable e) {
					System.out.println("something got thrwon:  " + e.getMessage());
					e.printStackTrace();
				}
			});
			
			Bukkit.getLogger().setFilter(new Filter() {
				
				@Override
				public boolean isLoggable(LogRecord record) {
					if (record.getThrown() != null) {
						System.out.println("soemtinf got thrown: " + record.getThrown().getMessage());
					}
					return true;
				}
			});
		} catch (Exception ex) {
			error("Fehler: " + ex.getMessage());
		}
		
		info("Websocket Stuff...");
		try {
			Core.getCore().getSocketHandler().registerPackets();
			String server = System.getProperty("server");
			if (server != null && server.equalsIgnoreCase("true")) {
				info("Starting server...");
				Core.getCore().getSocketHandler().startServer();
			}
			
			Bukkit.getScheduler().runTaskLater(this, new Runnable() {
				
				@Override
				public void run() {
					info("Starting Client...");
					Core.getCore().getSocketHandler().startClient();
				}
			}, 10);
		} catch (Exception ex) {
			error("Fehler: " + ex.getMessage());
		}
		
		info("Aktiviert!");
	}
	
	@Override
	public void onDisable() {
		if (update) {
			return;
		}
		info("Deaktivere...");
		
		info("Vorbereitung...");
		try {
			Core.getCore().getShutdownUtil().initShutdown();
		} catch (Exception ex) {
			error("Fehler: " + ex.getMessage());
		}
		
		info("Stoppe Client...");
		try {
			((CoreSocketClient) Core.getCore().getSocketHandler().getClient()).close();
		} catch (Exception ex) {
			error("Fehler: " + ex.getMessage());
		}
		
		info("Stoppe Server...");
		try {
			((CoreSocketServer) Core.getCore().getSocketHandler().getServer()).stop(30);
		} catch (Exception ex) {
			error("Fehler: " + ex.getMessage());
		}
		
		info("Unregister Listener...");
		try {
			HandlerList.unregisterAll(this);
		} catch (Exception ex) {
			error("Fehler: " + ex.getMessage());
		}
		
		info("Stoppe Tasks...");
		try {
			Bukkit.getScheduler().cancelTasks(this);
		} catch (Exception ex) {
			error("Fehler: " + ex.getMessage());
		}
		
		info("Deaktiviere Handler...");
		try {
			disableHandler();
		} catch (Exception ex) {
			error("Fehler: " + ex.getMessage());
		}
		
		info("Deaktiviert!");
	}
	
	private void disableHandler() {
		Core.getCore().getBarHandler();
		Core.getCore().getNametagHandler().disable();
	}
	
	private void fixReload() {
		for (Player p : Bukkit.getOnlinePlayers()) {
			User user = Core.getCore().getUserHandler().get(p.getUniqueId());
			user.startSession();
		}
	}
	
	private void enableHandler() {
		// Lag.init();
		// GhostFactory.getInstance(); //TODO Disabled due to a strange NPE
		Core.getCore().getProtocolHandler();
		Core.getCore().getServerHandler().startTask();
		Core.getCore().getSqlHandler();
		Core.getCore().getItemHandler().register();
		Core.getCore().getNametagHandler().enable();
	}
	
	private void registerListener() {
		Listener[] listeners = new Listener[] { new CoreUserListener(), new CoreChatListener(), Core.getCore().getProtocolHandler().getSignChangers(),
		        new CoreEventListener(), new CoreBlockListener() };
		for (Listener listener : listeners) {
			Bukkit.getPluginManager().registerEvents(listener, this);
		}
	}
	
	private void loadStuff() {
		info("Lade Stats...");
		if (!Core.getCore().getStatsHandler().loadAll()) {
			error("Stats wurden nicht geladen!");
		}
		info("Lade User...");
		if (!Core.getCore().getUserHandler().loadAll()) {
			error("User wurden nicht geladen!");
		}
		info("Lade Clients...");
		if (!Core.getCore().getClientHandler().loadAll()) {
			error("Clients wurden nicht geladen!");
		}
	}
	
	@Override
	public boolean onCommand(CommandSender sender, org.bukkit.command.Command command, String label, String[] args) {
		return Core.getCore().getCommandHandler().handleCommand(sender, label, command, args);
	}
	
	@Override
	public void debug(String s) {
		if (getConfig().isBoolean("debug")) {
			getLogger().info("[DEBUG]" + s);
		}
	}
	
	@Override
	public void info(String s) {
		getLogger().info(s);
	}
	
	@Override
	public void error(String s) {
		getLogger().severe(s);
	}
	
	@Override
	public void broadcast(FancyMessage msg) {
		for (Player p : getServer().getOnlinePlayers()) {
			msg.send(p);
		}
	}
	
	@Override
	public PermissionManager getPermissionManager() {
		return PermissionsEx.getPermissionManager();
	}
}
